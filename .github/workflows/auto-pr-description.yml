name: Auto PR Description

on:
  pull_request:
    types: [opened, reopened]

permissions:
  pull-requests: write
  contents: read

jobs:
  update-pr-description:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Generate PR description
        id: generate
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            const prNumber = context.issue.number;
            
            // PR ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            const pr = await github.rest.pulls.get({
              owner,
              repo,
              pull_number: prNumber
            });
            
            // ì»¤ë°‹ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
            const commits = await github.rest.pulls.listCommits({
              owner,
              repo,
              pull_number: prNumber
            });
            
            // íŒŒì¼ ë³€ê²½ ì‚¬í•­ ê°€ì ¸ì˜¤ê¸°
            const files = await github.rest.pulls.listFiles({
              owner,
              repo,
              pull_number: prNumber
            });
            
            // í†µê³„ ê³„ì‚°
            let additions = 0;
            let deletions = 0;
            files.data.forEach(file => {
              additions += file.additions;
              deletions += file.deletions;
            });
            
            // PR ì„¤ëª… ìƒì„±
            let description = `## ğŸ”„ ë³€ê²½ ì‚¬í•­ ìš”ì•½\n\n`;
            description += `ì´ PRì€ **${commits.data.length}ê°œì˜ ì»¤ë°‹**ê³¼ **${files.data.length}ê°œì˜ íŒŒì¼** ë³€ê²½ì„ í¬í•¨í•©ë‹ˆë‹¤.\n\n`;
            
            // ì»¤ë°‹ ëª©ë¡
            description += `## ğŸ“ ì»¤ë°‹ ëª©ë¡\n\n`;
            commits.data.forEach(commit => {
              const message = commit.commit.message.split('\n')[0]; // ì²« ì¤„ë§Œ
              const author = commit.commit.author.name;
              const sha = commit.sha.substring(0, 7);
              description += `- \`${sha}\` ${message} - *${author}*\n`;
            });
            
            // íŒŒì¼ ë³€ê²½ ì‚¬í•­
            description += `\n## ğŸ“‚ ìˆ˜ì •ëœ íŒŒì¼\n\n`;
            
            // íŒŒì¼ì„ íƒ€ì…ë³„ë¡œ ë¶„ë¥˜
            const filesByType = {
              frontend: [],
              backend: [],
              packages: [],
              config: [],
              docs: [],
              other: []
            };
            
            files.data.forEach(file => {
              const fileInfo = {
                name: file.filename,
                additions: file.additions,
                deletions: file.deletions,
                status: file.status
              };
              
              if (file.filename.startsWith('apps/frontend/')) {
                filesByType.frontend.push(fileInfo);
              } else if (file.filename.startsWith('apps/backend/')) {
                filesByType.backend.push(fileInfo);
              } else if (file.filename.startsWith('packages/')) {
                filesByType.packages.push(fileInfo);
              } else if (file.filename.match(/\.(json|ya?ml|config\.(js|ts|mjs|cjs)|\.config\.(js|ts|mjs|cjs))$/)) {
                filesByType.config.push(fileInfo);
              } else if (file.filename.match(/\.(md|txt)$/)) {
                filesByType.docs.push(fileInfo);
              } else {
                filesByType.other.push(fileInfo);
              }
            });
            
            // ê° íƒ€ì…ë³„ë¡œ íŒŒì¼ ì¶œë ¥
            const printFiles = (files, emoji, title) => {
              if (files.length > 0) {
                description += `\n### ${emoji} ${title}\n\n`;
                files.forEach(file => {
                  const statusEmoji = file.status === 'added' ? 'ğŸ†•' : 
                                     file.status === 'removed' ? 'ğŸ—‘ï¸' : 
                                     file.status === 'renamed' ? 'ğŸ“' : 'âœï¸';
                  description += `- ${statusEmoji} \`${file.name}\` (+${file.additions}, -${file.deletions})\n`;
                });
              }
            };
            
            printFiles(filesByType.frontend, 'ğŸ¨', 'Frontend');
            printFiles(filesByType.backend, 'âš™ï¸', 'Backend');
            printFiles(filesByType.packages, 'ğŸ“¦', 'Shared Packages');
            printFiles(filesByType.config, 'ğŸ”§', 'Configuration');
            printFiles(filesByType.docs, 'ğŸ“š', 'Documentation');
            printFiles(filesByType.other, 'ğŸ“„', 'Other');
            
            // í†µê³„
            description += `\n## ğŸ“Š í†µê³„\n\n`;
            description += `- **${files.data.length}** files changed\n`;
            description += `- **${additions}** insertions(+)\n`;
            description += `- **${deletions}** deletions(-)\n`;
            description += `- **${additions + deletions}** total changes\n`;
            
            // ë¸Œëœì¹˜ ì •ë³´
            description += `\n## ğŸŒ² ë¸Œëœì¹˜\n\n`;
            description += `- **From**: \`${pr.data.head.ref}\`\n`;
            description += `- **To**: \`${pr.data.base.ref}\`\n`;
            
            // í‘¸í„°
            description += `\n---\n`;
            description += `*ğŸ¤– ì´ ì„¤ëª…ì€ ìë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.*\n`;
            
            // PR ì—…ë°ì´íŠ¸
            await github.rest.pulls.update({
              owner,
              repo,
              pull_number: prNumber,
              body: description
            });
            
            console.log('PR description updated successfully!');
            return description;

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            const prNumber = context.issue.number;
            
            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: prNumber,
              body: 'âœ… PR ì„¤ëª…ì´ ìë™ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤! í•„ìš”ì‹œ ì§ì ‘ ìˆ˜ì •í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.'
            });

